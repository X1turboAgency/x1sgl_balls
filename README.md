# X1SGL Balls

X1turbo SGL Demo Balls

今回、New グラディウスデモを制作する上で、X1用のゲームライブラリとしてX1SGLという環境を用意しました。  
ソフトウェアスプライトやコンバータなどのプログラム制作環境です。  
  
X1SGLを使って描画性能用プログラム検証として、X1 Balls を作りました。  
16x16 プレーン1-3のスプライトを画面にどれくらい描画できるのかの検証プログラムです。

# X1 SGLとは
X1 SGL(X1 Super Game Library)は、X1/turboでソフトウェアスプライトの描画用ライブラリです。  
X1のハードウェアに特化した描画手法を模索していて、以下の機能を持っています。

#### ダブルバッファによるチラツキ対処
- X1シリーズは320x200x8色を２画面持つことできるので、表示面を表示している裏で
- 描画面に対して描画を行います。チラツキを抑え、滑らかなキャラクタ移動を実現できます。

#### 通常描画/重ね合わせの切替と最適化
- X1シリーズを始め、この頃の描画処理は、マスクとAndを取って、描画データとORすることで表示しています。
- この処理は描画負荷が重いので、SGLでは重ね合わせが必要無い箇所では直接書込むことで回避しています。
- それらの判定用に「ビットラインバッファ」というライン単位の仮想画面を使って判定しています。

#### GRAM配列に合わせた描画最適化
- X1のGRAMは 8ライン単位で並んでおり、縦方向にスムーズに描画する処理が書きにくいのですが、
- Y座標位置に合わせて、処理を場合分けすることで高速化を行っています。

#### 座標系による最適化
- 320x200の場合、横方向は8bitを超えてしまい、小数部を加えると24bitの座標系になり効率が落ちます。
- そこで、整数部9bit 小数部 7bitの座標系にすることで 16bitで扱うことでコンパクトにしています。
- また、2ドット単位で動作する場合は、上位8bitのみ計算すればよいというメリットがあります。

#### 同時アクセスモードによる消去処理
- 描画したキャラクタは消す必要がありますが、X1の場合は３プレーン同時に書き込める同時アクセスモードを
- 使う事でキャラクタクリアを高速化します。
  
#### プレーン数最適化による描画コスト削減
- データや描画処理を切り替えることで、1プレーン,２プレーン(Blue+Red,Blue+Green,Red+Green),3プレーン
- 描画を分けることで、描画処理/データ量を削減します。

# 操作説明
キーボードで操作します。  
1…Ball (プレーン1)を一つ発生させる。  
2…Ball (プレーン2)を一つ発生させる。  
3…Ball (プレーン3)を一つ発生させる。  
4…Ballを一つ消去する。  
スペースバー…押すたびに 60/30/20fps を切り替えます。  
  
# 表示項目
現在表示しているBallの数  
現在の表示FPS (60/30/20)  
処理落ち (Dropout) フレーム内で描画処理をオーバーすると「Dropout」を表示します。  
ちなみに60/30/20fpsでBallの移動速度を変えて見た目の速度が変わらないようにしています。  

# セットアップ / 環境
想定環境: Windows (64bit)  

ビルドに必要な実行ファイルは内包していますが、z80アセンブラ本体は同梱していません。  
アセンブラは、紅茶羊羹さんの z80asmを想定しています。こちらは別途入手して下さい。  
z80as.exe を、bin/z80as フォルダにコピーして下さい。  

# ビルド方法
project/build.bat を実行すると、アセンブルを行って、x1balls.d88 を作成します。  
エミュレータや実機で実行する事ができます。  

# プロジェクト/ファイル説明

| フォルダ名       | サブフォルダ | 説明                                                   |
|------------------|--------------|--------------------------------------------------------|
| bin              |              | ツール類                                               |
|                  | make2d.exe   | アセンブル済み.binファイルを .2d形式に変換します。     |
|                  | png2mrg.exe  | PNG画像をアセンブルファイル(.asm)に変換します。        |
|                  | x12d_d88.exe | 2dファイルをd88ファイルへ変換します。                  |
| res              |              | 画像リソースフォルダ                                   |
|                  | chara        | キャラクタ画像データ asm ファイルに変換します。        |
| src              |              |                                                        |
|                  | bitline      | ビットライン関連のファイル                             |
|                  | chara        | キャラ画像データ / キャラ実行マネージャ                |
|                  | data_work    | データワーク                                           |
|                  | game         | game / ball処理                                        |
|                  | input        | キーボード / 入力処理                                  |
|                  | render       | 描画処理 (B/R/G)                                       |
|                  | text         | テキスト処理                                           |
|                  | util         | 各種ユーティリティ                                     |
| main.am          |              | メイン処理                                             |
| boot_data.asm    |              | ブート処理                                             |
| crtc.asm         |              | crtc設定処理                                           |
| prog_end.asm     |              | プログラム終了判定                                     |
| macro_define.asm |              | マクロ設定                                             |
| value_define.asm |              | ラベル記述                                             |

# 謝辞
このプログラムのアセンブルは、紅茶羊羹さんの z80asm の使用を想定しています。  
Z80プログラム制作にいつも活用させて頂いています。  

# 更新履歴
2019/06/30 Ver 1.0 公開  

